#!/usr/bin/env bash

set -o pipefail

passdir=${PASSWORD_STORE_DIR:-$HOME/.password-store}

get_username() {
  local entry raw
  entry="$1"

  [[ -n "$entry" ]] || exit 1

  raw=$(pass show "$entry")
  
  echo "$raw" | grep '^username:' | sed 's/^username:\s*//' \
    || echo "$raw" | grep '^user:' | sed 's/^user:\s*//' \
    || echo "$raw" | grep '^email:' | sed 's/^email:\s*//' \
    || echo ""
}

option_menu() {
  local opt entry
  entry="$1"
  opt=$(echo -e "Username\nPassword\nOTP" | rofi -dmenu -i -p "Type")

  case "$opt" in
    "Username") 
      get_username "$entry"
    ;;
    "Password")
      pass show "$entry" | head -n1
    ;;
    "OTP")
      pass otp "$entry"
    ;;
    *) return 1 
    ;;
  esac
}

_write() {
  if [[ -n "$WAYLAND_DISPLAY" ]]; then 
    wtype "$@"
  else
    xdotool type "$@"
  fi
}

main() {
  local passwords entry res

  passwords=$(find -L "$passdir" -type f -name '*.gpg' -printf '%P\n' | sort | sed 's/\.gpg//')
  entry=$(echo "$passwords" | rofi -dmenu -i -p "Account")
  [[ -n "$entry" ]] || exit 1

  res=$(option_menu "$entry")

  _write "$res"
}

main
